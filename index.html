<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestione Inventario</title>
  
  <!-- 1. Carica Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Stile per nascondere le frecce negli input numerici (opzionale ma pulito) */
    input[type='number']::-webkit-inner-spin-button,
    input[type='number']::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type='number'] {
      -moz-appearance: textfield;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 font-sans">

  <div class="max-w-7xl mx-auto">
    
    <!-- Intestazione e Navigazione Viste -->
    <header class="mb-6">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4">Gestione Inventario e Ordini</h1>
      <nav class="flex space-x-2">
        <button id="nav-inventario"
          class="px-3 py-2 md:px-4 text-sm md:text-base rounded-lg font-semibold shadow-md transition-all duration-200 bg-blue-600 text-white">
          Inventario
        </button>
        <button id="nav-listaSpesa"
          class="px-3 py-2 md:px-4 text-sm md:text-base rounded-lg font-semibold shadow-md transition-all duration-200 bg-white text-gray-700">
          Lista Spesa
          <span id="shopping-list-badge" class="ml-2 bg-red-500 text-white text-xs font-bold rounded-full px-2 py-1 hidden">
          </span>
        </button>
      </nav>
    </header>

    <!-- Sezione Viste -->
    <main>
      
      <!-- ===== VISTA INVENTARIO (Mostrata/nascosta da JS) ===== -->
      <div id="view-inventario">
        <div class="space-y-6">
          
          <!-- Form Aggiungi Prodotto -->
          <div class="bg-white p-4 md:p-6 rounded-lg shadow-md">
            <h2 class="text-xl md:text-2xl font-semibold mb-4 text-gray-700">Aggiungi Nuovo Prodotto</h2>
            <form id="add-product-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <!-- Colonna 1 -->
              <div class="flex flex-col">
                <label class="mb-1 font-medium text-gray-600 text-sm">Nome Prodotto</label>
                <input type="text" name="nome" class="border rounded-md p-2 w-full shadow-sm" required>
              </div>
              <div class="flex flex-col">
                <label class="mb-1 font-medium text-gray-600 text-sm">Categoria</label>
                <input type="text" name="categoria" class="border rounded-md p-2 w-full shadow-sm" required>
              </div>
              <!-- Colonna 2 -->
              <div class="flex flex-col">
                <label class="mb-1 font-medium text-gray-600 text-sm">Fornitore</label>
                <input type="text" name="fornitore" class="border rounded-md p-2 w-full shadow-sm" required>
              </div>
              <div class="flex flex-col">
                <label class="mb-1 font-medium text-gray-600 text-sm">Prezzo (€)</label>
                <input type="number" name="prezzo" min="0" step="0.01" class="border rounded-md p-2 w-full shadow-sm" required>
              </div>
              <!-- Colonna 3 -->
              <div class="flex flex-col">
                <label class="mb-1 font-medium text-gray-600 text-sm">Q.tà Attuale</label>
                <input type="number" name="quantitaAttuale" min="0" step="1" class="border rounded-md p-2 w-full shadow-sm" required>
              </div>
              <div class="flex flex-col">
                <label class="mb-1 font-medium text-gray-600 text-sm">Q.tà Minima</label>
                <input type="number" name="quantitaMinima" min="0" step="1" class="border rounded-md p-2 w-full shadow-sm" required>
              </div>
              <!-- Colonna 4 -->
              <div class="flex flex-col">
                <label class="mb-1 font-medium text-gray-600 text-sm">Unità</label>
                <select name="unita" class="border rounded-md p-2 w-full bg-white shadow-sm" required>
                  <option value="kg">kg</option>
                  <option value="gr">gr</option>
                  <option value="pz" selected>pz</option>
                  <option value="ct">ct</option>
                </select>
              </div>
              
              <button type="submit" class="w-full md:col-span-2 lg:col-span-1 bg-blue-600 text-white rounded-md p-2.5 font-semibold shadow-md hover:bg-blue-700 transition-all duration-200 h-full self-end mt-2 md:mt-0">
                Aggiungi Prodotto
              </button>
            </form>
          </div>

          <!-- Filtri Vista Inventario -->
          <div class="flex flex-wrap items-center gap-2">
            <span class="font-medium text-gray-700">Raggruppa per:</span>
            <button id="group-categoria"
              class="px-3 py-1 rounded-md text-sm font-medium bg-blue-500 text-white">
              Categoria
            </button>
            <button id="group-fornitore"
              class="px-3 py-1 rounded-md text-sm font-medium bg-white shadow-sm">
              Fornitore
            </button>
          </div>

          <!-- Lista Prodotti Inventario -->
          <div id="inventory-list-container" class="space-y-6">
            <!-- Contenuto generato da JS -->
          </div>
        </div>
      </div>

      <!-- ===== VISTA LISTA SPESA (Mostrata/nascosta da JS) ===== -->
      <div id="view-listaSpesa" class="hidden">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-md">
          <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Lista della Spesa</h2>
          <div id="shopping-list-container" class="space-y-8">
            <!-- Contenuto generato da JS -->
          </div>
        </div>
      </div>
    </main>

  </div>

  <!-- 3. Il nostro codice JavaScript Vanilla -->
  <script type="module">
    // --- DATI DI ESEMPIO E STATO ---
    const defaultProducts = [
      { id: '1', nome: 'Mele Golden', categoria: 'Frutta', fornitore: 'Fruttivendolo Rossi', prezzo: 2.5, quantitaAttuale: 10, quantitaMinima: 5, unita: 'kg' },
      { id: '2', nome: 'Latte Intero', categoria: 'Latticini', fornitore: 'Caseificio Bianchi', prezzo: 1.2, quantitaAttuale: 3, quantitaMinima: 6, unita: 'pz' },
      { id: '3', nome: 'Parmigiano Reggiano', categoria: 'Latticini', fornitore: 'Caseificio Bianchi', prezzo: 20, quantitaAttuale: 1, quantitaMinima: 0.5, unita: 'kg' },
      { id: '4', nome: 'Pasta (Spaghetti)', categoria: 'Secchi', fornitore: 'Grossista Verdi', prezzo: 1.0, quantitaAttuale: 15, quantitaMinima: 10, unita: 'pz' },
      { id: '5', nome: 'Acqua Minerale', categoria: 'Bevande', fornitore: 'Grossista Verdi', prezzo: 0.5, quantitaAttuale: 2, quantitaMinima: 1, unita: 'ct' },
      { id: '6', nome: 'Pomodori Pelati', categoria: 'Secchi', fornitore: 'Grossista Verdi', prezzo: 0.8, quantitaAttuale: 5, quantitaMinima: 10, unita: 'pz' },
      { id: '7', nome: 'Bistecche di Manzo', categoria: 'Carne', fornitore: 'Macelleria Neri', prezzo: 25, quantitaAttuale: 0.2, quantitaMinima: 0.5, unita: 'kg' },
    ];

    const state = {
      currentView: 'inventario', // 'inventario' or 'listaSpesa'
      groupBy: 'categoria', // 'categoria' or 'fornitore'
      products: []
    };
    
    const unitOptions = ['kg', 'gr', 'pz', 'ct'];

    // --- SELETTORI DOM ---
    const $ = (selector) => document.querySelector(selector);
    const viewInventario = $('#view-inventario');
    const viewListaSpesa = $('#view-listaSpesa');
    const navInventario = $('#nav-inventario');
    const navListaSpesa = $('#nav-listaSpesa');
    const groupCategoria = $('#group-categoria');
    const groupFornitore = $('#group-fornitore');
    const addProductForm = $('#add-product-form');
    const inventoryListContainer = $('#inventory-list-container');
    const shoppingListContainer = $('#shopping-list-container');
    const shoppingListBadge = $('#shopping-list-badge');

    // --- FUNZIONI DI LOGICA ---

    /** Salva i prodotti nel localStorage */
    function saveProducts() {
      localStorage.setItem('inventoryApp.products', JSON.stringify(state.products));
    }

    /** Carica i prodotti dal localStorage o usa i dati di default */
    function loadProducts() {
      const storedProducts = localStorage.getItem('inventoryApp.products');
      if (storedProducts) {
        state.products = JSON.parse(storedProducts);
      } else {
        state.products = defaultProducts;
      }
    }

    /** Raggruppa i prodotti per una chiave (categoria o fornitore) */
    function getGroupedProducts() {
      const groupKey = state.groupBy;
      const grouped = state.products.reduce((acc, prodotto) => {
        const key = prodotto[groupKey] || 'Non Assegnato';
        if (!acc.has(key)) {
          acc.set(key, []);
        }
        acc.get(key).push(prodotto);
        return acc;
      }, new Map());
      
      return new Map([...grouped.entries()].sort((a, b) => a[0].localeCompare(b[0])));
    }

    /** Filtra e raggruppa i prodotti per la lista spesa */
    function getShoppingListGrouped() {
      const prodottiDaAcquistare = state.products.filter(
        p => p.quantitaAttuale <= p.quantitaMinima
      );
      const grouped = prodottiDaAcquistare.reduce((acc, prodotto) => {
        const key = prodotto.fornitore || 'Sconosciuto';
        if (!acc.has(key)) {
          acc.set(key, []);
        }
        acc.get(key).push(prodotto);
        return acc;
      }, new Map());
      
      return new Map([...grouped.entries()].sort((a, b) => a[0].localeCompare(b[0])));
    }

    /** Aggiunge un nuovo prodotto */
    function aggiungiProdotto(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const newProduct = { id: crypto.randomUUID() };
      for (let [key, value] of formData.entries()) {
        if (key === 'prezzo' || key === 'quantitaAttuale' || key === 'quantitaMinima') {
          newProduct[key] = parseFloat(value) || 0;
        } else {
          newProduct[key] = value;
        }
      }
      state.products.push(newProduct);
      saveProducts();
      render();
      e.target.reset();
    }

    /** Rimuove un prodotto */
    function rimuoviProdotto(id) {
      state.products = state.products.filter(p => p.id !== id);
      saveProducts();
      render();
    }

    /** Aggiorna un campo del prodotto (da input inline) */
    function updateProductField(id, field, value) {
      const product = state.products.find(p => p.id === id);
      if (product) {
        if (field === 'prezzo' || field === 'quantitaAttuale' || field === 'quantitaMinima') {
          product[field] = parseFloat(value) || 0;
        } else {
          product[field] = value;
        }
        saveProducts();
        render(); // Re-render per aggiornare colori, ecc.
      }
    }

    // --- FUNZIONI DI RENDER ---

    /** Funzione di render principale */
    function render() {
      renderNav();
      renderViews();
      renderInventoryList();
      renderShoppingList();
      renderBadge();
    }

    /** Aggiorna i pulsanti di navigazione */
    function renderNav() {
      if (state.currentView === 'inventario') {
        navInventario.classList.add('bg-blue-600', 'text-white');
        navInventario.classList.remove('bg-white', 'text-gray-700');
        navListaSpesa.classList.add('bg-white', 'text-gray-700');
        navListaSpesa.classList.remove('bg-blue-600', 'text-white');
      } else {
        navListaSpesa.classList.add('bg-blue-600', 'text-white');
        navListaSpesa.classList.remove('bg-white', 'text-gray-700');
        navInventario.classList.add('bg-white', 'text-gray-700');
        navInventario.classList.remove('bg-blue-600', 'text-white');
      }
      
      if (state.groupBy === 'categoria') {
        groupCategoria.classList.add('bg-blue-500', 'text-white');
        groupCategoria.classList.remove('bg-white', 'shadow-sm');
        groupFornitore.classList.add('bg-white', 'shadow-sm');
        groupFornitore.classList.remove('bg-blue-500', 'text-white');
      } else {
        groupFornitore.classList.add('bg-blue-500', 'text-white');
        groupFornitore.classList.remove('bg-white', 'shadow-sm');
        groupCategoria.classList.add('bg-white', 'shadow-sm');
        groupCategoria.classList.remove('bg-blue-500', 'text-white');
      }
    }

    /** Mostra la vista corretta */
    function renderViews() {
      viewInventario.classList.toggle('hidden', state.currentView !== 'inventario');
      viewListaSpesa.classList.toggle('hidden', state.currentView !== 'listaSpesa');
    }

    /** Genera l'HTML per la select delle unità */
    function getUnitOptionsHTML(selectedValue) {
      return unitOptions.map(unita => 
        `<option value="${unita}" ${unita === selectedValue ? 'selected' : ''}>${unita}</option>`
      ).join('');
    }

    /** Renderizza la lista dell'inventario */
    function renderInventoryList() {
      const grouped = getGroupedProducts();
      if (grouped.size === 0) {
        inventoryListContainer.innerHTML = `<div class="bg-white p-6 rounded-lg shadow text-center text-gray-500">
          Nessun prodotto nell'inventario. Inizia aggiungendone uno!
        </div>`;
        return;
      }
      
      let html = '';
      for (let [groupKey, prodotti] of grouped) {
        html += `<section>
          <h2 class="text-xl md:text-2xl font-bold text-gray-700 mt-6 mb-3 border-b-2 border-gray-300 pb-2 capitalize">
            ${groupKey}
          </h2>
          <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
            ${prodotti.map(prodotto => {
              const borderClass = prodotto.quantitaAttuale <= prodotto.quantitaMinima ? 'border-l-4 border-red-500' : 'border-transparent';
              const qtyClass = prodotto.quantitaAttuale <= prodotto.quantitaMinima ? 'text-red-600' : 'text-green-600';
              
              return `<div class="bg-white shadow-lg rounded-lg p-4 transition-all duration-300 ${borderClass}">
                <div class="flex justify-between items-start mb-3">
                  <input type="text" value="${prodotto.nome}" data-id="${prodotto.id}" data-field="nome"
                    class="editable-input text-lg md:text-xl font-bold text-blue-800 border-b-2 border-transparent focus:border-blue-300 outline-none w-2/3">
                  <button class="remove-btn text-red-500 hover:text-red-700 font-semibold transition-colors text-sm flex-shrink-0 ml-2" data-id="${prodotto.id}">
                    Rimuovi
                  </button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-3 text-sm text-gray-600">
                  <!-- Categoria -->
                  <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-500">Categoria</label>
                    <input type="text" value="${prodotto.categoria}" data-id="${prodotto.id}" data-field="categoria"
                      class="editable-input border-b border-transparent focus:border-gray-300 outline-none w-full">
                  </div>
                  <!-- Fornitore -->
                  <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-500">Fornitore</label>
                    <input type="text" value="${prodotto.fornitore}" data-id="${prodotto.id}" data-field="fornitore"
                      class="editable-input border-b border-transparent focus:border-gray-300 outline-none w-full">
                  </div>
                  <!-- Prezzo -->
                  <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-500">Prezzo</label>
                    <div class="flex items-center">
                      <span class="mr-1">€</span>
                      <input type="number" value="${prodotto.prezzo}" data-id="${prodotto.id}" data-field="prezzo"
                        class="editable-input w-20 border-b border-transparent focus:border-gray-300 outline-none">
                    </div>
                  </div>
                  <!-- Q.tà Attuale -->
                  <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-500">Q.tà Attuale</label>
                    <input type="number" value="${prodotto.quantitaAttuale}" data-id="${prodotto.id}" data-field="quantitaAttuale"
                      class="editable-input w-16 border-b border-transparent focus:border-gray-300 outline-none font-medium ${qtyClass}">
                  </div>
                  <!-- Q.tà Minima -->
                  <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-500">Q.tà Minima</label>
                    <input type="number" value="${prodotto.quantitaMinima}" data-id="${prodotto.id}" data-field="quantitaMinima"
                      class="editable-input w-16 border-b border-transparent focus:border-gray-300 outline-none">
                  </div>
                  <!-- Unità -->
                  <div class="flex flex-col">
                    <label class="text-xs font-semibold text-gray-500">Unità</label>
                    <select data-id="${prodotto.id}" data-field="unita"
                      class="editable-input w-20 border-b bg-white border-transparent focus:border-gray-300 outline-none">
                      ${getUnitOptionsHTML(prodotto.unita)}
                    </select>
                  </div>
                </div>
              </div>`;
            }).join('')}
          </div>
        </section>`;
      }
      inventoryListContainer.innerHTML = html;
    }

    /** Renderizza la lista della spesa */
    function renderShoppingList() {
      const grouped = getShoppingListGrouped();
      if (grouped.size === 0) {
        shoppingListContainer.innerHTML = `<div class="text-center text-gray-500 py-10">
          <p class="text-lg">La tua lista della spesa è vuota!</p>
          <p class="text-sm md:text-base">I prodotti appariranno qui automaticamente quando la loro quantità scende sotto il minimo.</p>
        </div>`;
        return;
      }
      
      let html = '';
      for (let [groupKey, prodotti] of grouped) {
        html += `<section>
          <h3 class="text-xl md:text-2xl font-semibold text-blue-700 mb-3 border-b border-blue-200 pb-2">
            Fornitore: <span class="font-bold">${groupKey}</span>
          </h3>
          <ul class="list-disc list-inside pl-2 md:pl-4 space-y-2">
            ${prodotti.map(prodotto => `
              <li class="text-gray-800 text-base md:text-lg">
                <span class="font-semibold">${prodotto.nome}</span>
                <span class="block text-sm text-gray-600 ml-6 md:ml-2 md:inline">
                  (Attuale: <strong class="text-red-600">${prodotto.quantitaAttuale}</strong> / Min: ${prodotto.quantitaMinima}) - ${prodotto.unita}
                </span>
              </li>
            `).join('')}
          </ul>
        </section>`;
      }
      shoppingListContainer.innerHTML = html;
    }
    
    /** Aggiorna il badge della lista spesa */
    function renderBadge() {
        const grouped = getShoppingListGrouped();
        const totalItems = Array.from(grouped.values()).reduce((acc, prodotti) => acc + prodotti.length, 0);
        
        if (totalItems > 0) {
            shoppingListBadge.textContent = totalItems;
            shoppingListBadge.classList.remove('hidden');
        } else {
            shoppingListBadge.classList.add('hidden');
        }
    }

    // --- EVENT LISTENERS ---

    /** Cambia vista */
    navInventario.addEventListener('click', () => {
      state.currentView = 'inventario';
      render();
    });
    navListaSpesa.addEventListener('click', () => {
      state.currentView = 'listaSpesa';
      render();
    });

    /** Cambia raggruppamento */
    groupCategoria.addEventListener('click', () => {
      state.groupBy = 'categoria';
      render();
    });
    groupFornitore.addEventListener('click', () => {
      state.groupBy = 'fornitore';
      render();
    });

    /** Aggiunge prodotto */
    addProductForm.addEventListener('submit', aggiungiProdotto);

    /** Listener per rimuovere e modificare */
    document.body.addEventListener('click', (e) => {
      const removeButton = e.target.closest('.remove-btn');
      if (removeButton) {
        const id = removeButton.dataset.id;
        rimuoviProdotto(id);
      }
    });
    
    document.body.addEventListener('change', (e) => {
        if (e.target.classList.contains('editable-input')) {
            const { id, field } = e.target.dataset;
            updateProductField(id, field, e.target.value);
        }
    });

    // --- INIZIALIZZAZIONE ---
    loadProducts();
    render();

  </script>
</body>
</html>

